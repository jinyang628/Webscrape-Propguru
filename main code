#General Dev Log
"""
- Filters (should try to print out all inputs and allow users to go back if they realise its wrong)
- Distance from (chosen property)
- The CONDITION column cant be scraped, but we should have an interface for users to input condition/drop down excel format
- RENT check + invalid input response
- BLOCK (FIND A SOLUTION TO MESSY LISTINGS), FLOOR LEVEL (MUST OPEN A NEW TAB - necessary?)

PROGRESS
    - SELL ready!
    - Excel ready!
    - Listing ID ready!
    - PPG LINK ready

#1
Issue: if you enter rubbish into the keyword prompt, where rubbish is anything that the website's search engine will not return
valid results of, the code will artificially stop

Thoughts: Might be a problem because someone who does not code (e.g. an average employee) cannot immediately
differentiate between faulty code vs invalid keyword input

Response: Not impossible to solve - I can simply program the code to differentiate between "invalid keyword input" and "faulty code"
    Assumption 1: if the code is working fine and the problem lies with the keyword input, the code still accesses the website
        I can program the code to recognise the "invalid input webpage" that is displayed by propertyguru
    Assumption 2: if the code is bugged and the problem is NOT with the keyword input, chances are we wont even be able to access
    the website

    Significance: I think this is a late-stage dev issue to tackle (high effort low return)

#2
Integration challenges - probably need build executable interface?
if not we have to expect every employee to literally download pycharm, access this code, and run it. Definitely
possible but doesn't really sound like a very scalable/efficient idea in the long run

Response: Definitely possible to do up an interface. Problem is I'm not an expert at this and I need time and space to
learn how to do it. Probably need ~5 full working days' worth of time to learn + do up a good one.

#3
Some use Completion 2020 instead of Built 2020 (adjust the filter word)

#PAST OBSTACLES
Some of the listings have fewer than 3 tags and data is mismatched (SOLVED)

BIG listings (turbo) coded differently, need to adjust the scrape for those (SOLVED)

CAPTCHA problem (SOLVED)
- important lesson learnt here (if site is coded properly and page isnt loaded simultaneously with the captcha, simply
    close and reopen the browser and alter the link to next page

yio chu kang example (split into both floor and land area, while 99% of other searches return a single value for
floor size) (SOLVED)
"""
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from datetime import date
import xlsxwriter #NOTE: MUST USE MODULES THAT SUPPORT XLSX FORMAT (AND NOT XLS)
import time
import requests
import re

s = Service(ChromeDriverManager().install())
browser = webdriver.Chrome(service = s)

def show_chosen_filters():
    global property_filter_check
    global price_filter_check
    global bedroom_filter_check
    global floor_size_check
    global psf_check
    global bathroom_check
    global tenure_check
    global build_year_check
    global floor_level_check
    global furnishing_check
    global listed_date_check

    print(f"Property Filters: {property_filter_check}")
    print(f"Price Filters: {price_filter_check}")
    print(f"Bedroom Filters: {bedroom_filter_check}")
    print(f"Floorsize Filters: {floor_level_check}")
    print(f"PSF Filters: {psf_check}")
    print(f"Bathroom Filters: {bathroom_check}")
    print(f"Tenure Filters: {tenure_check}")
    print(f"Build Year Filters: {build_year_check}")
    print(f"Floor Level Filters: {floor_level_check}")
    print(f"Furnishing Filters: {furnishing_check}")
    print(f"Listed Date Filters: {listed_date_check}")


def webscrape_PropGuru():
    global browser
    global property_filter_check
    global price_filter_check
    global bedroom_filter_check
    global floor_size_check
    global psf_check
    global bathroom_check
    global tenure_check
    global build_year_check
    global floor_level_check
    global furnishing_check
    global listed_date_check

    listing_counter = 0
    street_address_column = []
    price_column = []
    bed_count_column = []
    bath_count_column = []
    floor_area_column = []
    psf_column = []
    distance_to_nearest_transport_column = []
    property_type_column = []
    built_year_column = []
    type_of_leasehold_column = []
    lease_years_left_column = []
    ppg_link_column = []
    block_number_column = []
    
    todays_date = date.today()

    exit_1 = False
    while exit_1 == False:
        key_word = input("Enter keyword(s): ")
        print()
        if key_word == None:
            print("Invalid input")
            print()
        else:
            exit_1 = True
    
    exit_2 = False
    rent_or_sell_query = ""
    while exit_2 == False:
        rent_or_sell = input("Enter 1 for RENT OR Enter 2 for SELL: ")
        print()
        if rent_or_sell == "1":
            rent_or_sell_query = "RENT"
            exit_2 = True
        elif rent_or_sell == "2":
            rent_or_sell_query = "SELL"
            exit_2 = True
        else:
            print("Invalid input")
            print("Please enter the number 1 or 2")
            print()

    exit_additional_filters = False
    while exit_additional_filters == False:
        query = input("Do you want to insert additional filters? Enter 1 for YES or Enter 2 for NO: ")
        print()
        if query == "2":
            exit_additional_filters = True
        elif query == "1":
            property_filter_check = "NIL"
            price_filter_check = "NIL"
            bedroom_filter_check = "NIL"
            floor_size_check = "NIL"
            psf_check = "NIL"
            bathroom_check = "NIL"
            tenure_check =  "NIL"
            build_year_check = "NIL"
            floor_level_check = "NIL"
            furnishing_check = "NIL"
            listed_date_check = "NIL"

            exit_property_type_filters = False
            while exit_property_type_filters == False:
                query = input("Do you want to insert property type filters? Enter 1 for Yes or Enter 2 for NO: ")
                print()
                if query == "2":
                    exit_property_type_filters = True
                elif query == "1":
                    exit_property_type_choice = False
                    while exit_property_type_choice == False:
                        query = input("Enter 1 for Condo, Enter 2 for Landed or Enter 3 for HDB: ")
                        print()
                        if query == "1":
                            property_filter_check = "Condo"
                        elif query == "2":
                            property_filter_check = "Landed"
                        elif query == "3":
                            property_filter_check = "HDB"
                        else:
                            print("Invalid input")
                            print("Please enter the numbers 1,2 or 3")
                            print()
                            continue
                        exit_property_type_filters = True
                        exit_property_type_choice = True
                else:
                    print("Invalid input")
                    print("Please enter the number 1 or 2")
                    print()
                    continue

            show_chosen_filters()

            exit_price_filters = False
            while exit_price_filters == False:
                query = input("Do you want to insert price filters? Enter 1 for Yes or Enter 2 for NO: ")
                print()
                if query == "2":
                    exit_price_filters = True
                elif query == "1":
                    print("Note: Value will be rounded off to the nearest possible option on propertyguru's website") #min value round down, max value round up
                    print()
                    exit_min_price = False
                    while exit_min_price == False:
                        min_price_input = input("Enter minimum price: ")
                        print()
                        min_price_confirmation = input(
                            f"You entered ${min_price_input}. Enter 1 to confirm or Enter 2 to re-enter the value: ")
                        print()
                        if min_price_confirmation == "1":
                            exit_min_price = True
                        elif min_price_confirmation == "2":
                            continue
                        else:
                            print("Invalid input")
                            print("Please enter the number 1 or 2")
                            print()

                    exit_max_price = False
                    while exit_max_price == False:
                        max_price_input = input("Enter maximum price: ")
                        print()
                        max_price_confirmation = input(
                            f"You entered ${max_price_input}. Enter 1 to confirm or Enter 2 to re-enter the value: ")
                        print()
                        if max_price_confirmation == "1":
                            exit_max_price = True
                        elif max_price_confirmation == "2":
                            continue
                        else:
                            print("Invalid input")
                            print("Please enter the number 1 or 2")
                            print()

            show_chosen_filters()

        else:
            print("Invalid input")
            print("Please enter the number 1 or 2")
            print()
            continue

    exit_3 = False
    while exit_3 == False:
        number_of_pages = input("Enter number of pages to scrape: ")
        print()
        if number_of_pages.isdigit():
            exit_3 = True
        else:
            print("Input is NOT a valid number")
            print("Please enter a valid number")
            print()

    url_base = "https://www.propertyguru.com.sg/property-for-"

    if rent_or_sell_query == "RENT":
        url_base += "rent/1?freetext="
    else:
        url_base += "sale/1?freetext="

    list = key_word.split(" ")
    for word in list:
        if word != list[-1]:
            url_base += (word + "+")
        else:
            url_base += word

    url = url_base
    browser.get(url)
    page = requests.get(url)
    soup = BeautifulSoup(browser.page_source, "html.parser")

    # Check for all possible property type labels
    property_type_filters = ["HDB Flat"]
    property_type_scout = soup.find_all(class_="property-type-filter-select-all icon-checkbox")
    for option in property_type_scout:
        property_type_filters.append(option.text.strip())

    # Check for all lease year types
    lease_year_type_filters = []
    # PRIVATE NOTE TO SELF: This is a very good example of cancelling extra spaces found in the HTML code - if you copy
    # and paste the class name u will return a None value because of the extra spaces in between
    lease_year_type_section = soup.find("div", {
        "class": "search-field tenure checkbox-multi-column search-filter-js-content param-tenure js-form-group btn-group tide-to tide-to-listing_type"})
    lease_year_type_scout = lease_year_type_section.find_all("ul", {"class": "checkbox-tree"})
    for option in lease_year_type_scout:
        lease_year_type_filters.append(option.text.strip())

    page_counter = 1
    exit_main = False
    while exit_main == False:
        bowl_1 = soup.find_all(class_="col-xs-12 col-sm-7 listing-description")
        bowl_2 = soup.find_all(class_="col-xs-12 col-sm-12 listing-description")
        bowls = bowl_1 + bowl_2

        listing_bowl = soup.decode()
        listing_id_scout = re.findall('data-listing-id="[0-9]+"', listing_bowl)
        list_of_listing_id = []
        for listing_id in listing_id_scout:
            index_number = listing_id.rfind('=')
            if listing_id[index_number + 2:len(listing_id)-1] not in list_of_listing_id:
                list_of_listing_id.append(listing_id[index_number + 2:len(listing_id)-1])

        for listing in bowls:
            floor_area = "NIL"
            psf_value = "NIL"

            listing_counter += 1

            try:
                ppg_link = listing.a["href"]
            except AttributeError:
                break

            try:
                street_address = listing.find("span", {"itemprop" : "streetAddress"}).text.strip()
            except AttributeError:
                break

            block_number_scout = street_address.split(" ")
            block_number = block_number_scout[0]
            if not block_number[0].isdigit(): #ASSUMES that if the first character of block number is a number
                block_number = "" ###NEED FIND A WAY

            try:
                price = listing.find("span", {"class" : "price"}).text.strip()
            except AttributeError:
                break

            try:
                bed_count = listing.find("span", {"class" : "bed"}).text.strip()
            except AttributeError:
                break

            try:
                bath_count = listing.find("span", {"class" : "bath"}).text.strip()
            except AttributeError:
                break

            try:
                area_psf_section = listing.find_all("li", {"class" : "listing-floorarea pull-left"})
                for option in area_psf_section:
                    if "sqft" in option.text.strip():
                        floor_area = option.text.strip()
                    elif "psf" in option.text.strip():
                        psf_value = option.text.strip()
            except AttributeError:
                break

            distance_to_transport = ""
            try:
                distance_to_transport_recipes = listing.find_all("li")
                for dish in distance_to_transport_recipes:
                    if "mins" in dish.text.strip():
                        distance_to_transport = dish.text.strip()
                        break
            except AttributeError:
                distance_to_transport = "NIL"
            if distance_to_transport == "":
                distance_to_transport = "NIL"

            tagging_info_section = listing.find("ul", {"class" : "listing-property-type"})
            taggings = tagging_info_section.find_all("li", {"class" : ""})

            property_type_known = False
            built_year_known = False
            lease_year_type_known = False
            exit_tagging_1 = False
            exit_tagging_2 = False
            exit_tagging_3 = False

            while exit_tagging_1 == False:
                try:
                    tagging_1 = taggings[0].text.strip()
                except IndexError:
                    property_type = "NIL"
                    lease_year_type = "NIL"
                    built_year = "NIL"
                    exit_tagging_1 = True
                    exit_tagging_2 = True
                    exit_tagging_3 = True
                if tagging_1 in property_type_filters:
                    property_type = tagging_1
                    property_type_known = True
                    exit_tagging_1 = True
                elif tagging_1 in lease_year_type_filters:
                    property_type = "NIL"
                    lease_year_type = tagging_1
                    lease_year_type_known = True
                    exit_tagging_1 = True
                elif "Built" in tagging_1:
                    property_type = "NIL"
                    lease_year_type = "NIL"
                    built_year = tagging_1
                    built_year_known = True
                    exit_tagging_1 = True
                else:
                    print("FAULTY CODE#1")

            while exit_tagging_2 == False:
                try:
                    tagging_2 = taggings[1].text.strip()
                except IndexError:
                    if property_type_known == False:
                       property_type = "NIL"
                    elif built_year_known == False:
                        built_year = "NIL"
                    elif lease_year_type_known == False:
                        lease_year_type = "NIL"
                    exit_tagging_2 = True
                    exit_tagging_3 = True
                if tagging_2 in lease_year_type_filters:
                    lease_year_type = tagging_2
                    lease_year_type_known = True
                    exit_tagging_2 = True
                elif "Built" in tagging_2:
                    lease_year_type = "NIL"
                    built_year = tagging_2
                    exit_tagging_2 = True
                    exit_tagging_3 = True
                else:
                    print("FAULTY CODE#2")

            while exit_tagging_3 == False:
                try:
                    tagging_3 = taggings[2].text.strip()
                    built_year = tagging_3
                    exit_tagging_3 = True
                except IndexError:
                    if property_type_known == False:
                       property_type = "NIL"
                    elif built_year_known == False:
                        built_year = "NIL"
                    elif lease_year_type_known == False:
                        lease_year_type = "NIL"
                    exit_tagging_3 = True

            try:
                lease_years_left = (int(lease_year_type[:2]) - (int(todays_date.year) - int(built_year[-4:])))
            except ValueError:
                lease_years_left = "NIL"

            #FOR CHECKING/IF WE WANT TO READ THE DATA OFF PYTHON CONSOLE
            print(f"Listing[{listing_counter}]")
            print(f"Street Address: {street_address}")
            print(f"Price: {price}")
            print(f"Bedrooms: {bed_count}")
            print(f"Bathrooms: {bath_count}")
            print(f"Sqft: {floor_area}")
            print(f"PSF: {psf_value[3:-4]}")
            print(f"Distance to Nearest Transport: {distance_to_transport}")
            print(f"Property Type: {property_type}")
            print(f"Built Year: {built_year}")
            print(f"Type of Leasehold: {lease_year_type}")
            print(f"Lease years left: {lease_years_left}")
            print(f"PPG Link: {ppg_link}")
            print(f"Block number: {block_number}")
            print()

            #FINAL PRODUCT ON EXCEL
            street_address_column.append(street_address)
            price_column.append(price)
            bed_count_column.append(bed_count)
            bath_count_column.append(bath_count)
            floor_area_column.append(floor_area)
            psf_column.append(psf_value)
            distance_to_nearest_transport_column.append(distance_to_transport)
            property_type_column.append(property_type)
            built_year_column.append(built_year)
            type_of_leasehold_column.append(lease_year_type)
            lease_years_left_column.append(lease_years_left)
            ppg_link_column.append(ppg_link)
            block_number_column.append(block_number)

        # quits the old browser to avoid initiating captcha
        browser.quit()
        page_counter += 1
        if page_counter > int(number_of_pages):
            exit_main = True
            continue

        url_base = "https://www.propertyguru.com.sg/property-for-"

        if rent_or_sell_query == "RENT":
            url_base += "rent/"
        else:
            url_base += "sale/"

        url_base += (str(page_counter) + "?freetext=")

        list = key_word.split(" ")
        for word in list:
            if word != list[-1]:
                url_base += (word + "+")
            else:
                url_base += word

        browser = webdriver.Chrome(service = s)

        url = url_base
        browser.get(url)
        soup = BeautifulSoup(browser.page_source, "html.parser")

    #NOTE xlsxwriter does not allow me to modify existing files. It can only create new files
    #Openpyxl is an alternative module but idk why it just keeps bugging out for me
    workbook = xlsxwriter.Workbook(f"{key_word}" + ".xlsx")
    worksheet = workbook.add_worksheet("Data")

    #STOPPED HERE READJUST HEADERS FOR XLSXRWITER FORMAT
    #Fill up headers
    worksheet.write(0, 0, "Listing ID")
    worksheet.write(0, 1, "PPG Link ID")
    worksheet.write(0, 2, "Street Address")
    worksheet.write(0, 3, "Price")
    worksheet.write(0, 4, "Bedrooms")
    worksheet.write(0, 5, "Bathrooms")
    worksheet.write(0, 6, "Sqft")
    worksheet.write(0, 7, "PSF")
    worksheet.write(0, 8, "Distance to Nearest Transport")
    worksheet.write(0, 9, "Property Type")
    worksheet.write(0, 10, "Built Year")
    worksheet.write(0, 11, "Type of Leasehold")
    worksheet.write(0, 12, "Lease years left")
    worksheet.write(0, 13, "PPG Link")
    worksheet.write(0, 14, "Block")

    number = 0
    for row_number in range(1, listing_counter + 1):
        number += 1
        worksheet.write(row_number, 0, number)

    list_of_listing_id_column_rowcounter = 0
    for entry in list_of_listing_id:
        list_of_listing_id_column_rowcounter += 1
        worksheet.write(list_of_listing_id_column_rowcounter, 1, entry)

    street_address_column_rowcounter = 0
    for entry in street_address_column:
        street_address_column_rowcounter += 1
        worksheet.write(street_address_column_rowcounter, 2, entry)

    price_column_rowcounter = 0
    for entry in price_column:
        modified_price_input = "$" + entry
        price_column_rowcounter += 1
        worksheet.write(price_column_rowcounter, 3, modified_price_input)

    bed_count_column_rowcounter = 0
    for entry in bed_count_column:
        bed_count_column_rowcounter += 1
        worksheet.write(bed_count_column_rowcounter, 4, entry)

    bath_count_column_rowcounter = 0
    for entry in bath_count_column:
        bath_count_column_rowcounter += 1
        worksheet.write(bath_count_column_rowcounter, 5, entry)

    floor_area_column_rowcounter = 0
    for entry in floor_area_column:
        modified_floor_area_input = entry.replace(" sqft", "")
        floor_area_column_rowcounter += 1
        worksheet.write(floor_area_column_rowcounter, 6, modified_floor_area_input)

    psf_column_rowcounter = 0
    for entry in psf_column:
        modified_psf_input_draft = ""
        for character in entry:
            if character.isdigit() or character == ".":
                modified_psf_input_draft += character
        modified_psf_input = round(float(modified_psf_input_draft))
        psf_column_rowcounter += 1
        worksheet.write(psf_column_rowcounter, 7, modified_psf_input)

    distance_to_nearest_transport_column_rowcounter = 0
    for entry in distance_to_nearest_transport_column:
        distance_to_nearest_transport_column_rowcounter += 1
        worksheet.write(distance_to_nearest_transport_column_rowcounter, 8, entry)

    property_type_column_rowcounter = 0
    for entry in property_type_column:
        property_type_column_rowcounter += 1
        worksheet.write(property_type_column_rowcounter, 9, entry)

    built_year_column_rowcounter = 0
    for entry in built_year_column:
        built_year_column_rowcounter += 1
        if entry == "NIL":
            worksheet.write(built_year_column_rowcounter, 10, entry)
        else:
            worksheet.write(built_year_column_rowcounter, 10, entry[7:])

    type_of_leasehold_column_rowcounter = 0
    for entry in type_of_leasehold_column:
        type_of_leasehold_column_rowcounter += 1
        worksheet.write(type_of_leasehold_column_rowcounter, 11, entry)

    lease_years_left_column_rowcounter = 0
    for entry in lease_years_left_column:
        lease_years_left_column_rowcounter += 1
        worksheet.write(lease_years_left_column_rowcounter, 12, entry)

    ppg_link_rowcounter = 0
    for entry in ppg_link_column:
        ppg_link_rowcounter += 1
        worksheet.write(ppg_link_rowcounter, 13, entry)

    block_number_rowcounter = 0
    for entry in block_number_column:
        block_number_rowcounter += 1
        worksheet.write(block_number_rowcounter, 14, entry)

    workbook.close()

webscrape_PropGuru()

