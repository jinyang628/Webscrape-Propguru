from bs4 import BeautifulSoup
from threading import Thread
import selenium
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from datetime import date
import xlsxwriter  # NOTE: MUST USE MODULES THAT SUPPORT XLSX FORMAT (AND NOT XLS)
import time
import requests
import re

s = Service(ChromeDriverManager().install())
browser = webdriver.Chrome(service=s)

def task(url_submission):
    browser.get(url_submission)
    page = requests.get(url_submission)
    soup = BeautifulSoup(browser.page_source, "html.parser")
    price = (soup.find("span", {"class":"element-label price"})).text.strip()
    bedroom_number = (soup.find("div", {"class":"property-info-element beds"})).text.strip()
    bathroom_number = (soup.find("div", {"class":"property-info-element baths"})).text.strip()
    floor_size_scout = (soup.find("div", {"class":"property-info-element area"})).text.strip()
    floor_size = ""
    for char in floor_size_scout:
        if char.isdigit():
            floor_size += char
    floor_level_scout = (soup.find("tr", {"class": "property-attr floor-level"}))
    floor_level = floor_level_scout.find(class_ = "value-block").text.strip()
    block_number_scout = (soup.find("span", {"itemprop":"streetAddress"})).text.strip()
    block_number = (block_number_scout.split(" "))[0]
    psf = round(int(price)/int(floor_size))

    print(f"Price: {price}")
    print(f"Bedroom number: {bedroom_number}")
    print(f"Bathroom number: {bathroom_number}")
    print(f"Floor size: {floor_size}")
    print(f"Floor level: {floor_level}")
    print(f"Block number: {block_number}")
    print(f"PSF: {psf}")

    return [bedroom_number, bathroom_number, block_number, floor_level, price, floor_size, psf, url_submission]

def write_in_excel_row(number):
    global worksheet
    global info_list

    # LISTING ID
    worksheet.write(number, 0, number)

    # AGENT
    worksheet.write(number, 1, "Competitor")

    # BEDROOMS
    worksheet.write(number, 2, info_list[0])

    # BATHROOMS
    worksheet.write(number, 3, info_list[1])

    # BLOCK NUMBER
    worksheet.write(number, 4, info_list[2])

    # FLOOR
    worksheet.write(number, 5, info_list[3])

    # CONDITION BLANK

    # PRICE
    worksheet.write(number, 7, info_list[4])

    # FLOOR SIZE
    worksheet.write(number, 8, info_list[5])

    # PSF
    worksheet.write(number, 9, info_list[6])

    # PPG LINK
    worksheet.write(number, 10, info_list[7])

    # PPG LINK ID CORRECT
    list_of_listing_id_column_rowcounter = 0
    for entry in list_of_listing_id:
        list_of_listing_id_column_rowcounter += 1
        worksheet.write(list_of_listing_id_column_rowcounter, 11, entry)

def webscrape():
    global worksheet
    global info_list

    exit_URL_entry = False
    counter = 0
    list_of_URLs = []
    while exit_URL_entry == False:
        counter += 1
        url = input(
f"""
Enter URL {counter} 
If you have finished submitting all your URLs, enter DONE
""")
        if url.upper() != "DONE":
            list_of_URLs.append(url)

            #For checking purposes (might need to allow user to go back and change their previous inputs?)
            print(list_of_URLs)
        else:
            exit_URL_entry = True

    file_name_query = input("Enter filename: ")

    #will need to change save_location based on user
    save_location = "/Users/jinyangchen/PycharmProjects/Webscrape PropertyGuru/"

    # NOTE xlsxwriter does not allow me to modify existing files. It can only create new files
    # Openpyxl is an alternative module but idk why it just keeps bugging out for me
    workbook = xlsxwriter.Workbook(save_location + f"{file_name_query}" + ".xlsx")
    worksheet = workbook.add_worksheet("Data")

    # Fill up headers
    worksheet.write(0, 0, "Listing ID")
    worksheet.write(0, 1, "Agent")
    worksheet.write(0, 2, "Bedrooms")
    worksheet.write(0, 3, "Bathrooms")
    worksheet.write(0, 4, "Block")
    worksheet.write(0, 5, "Floor")
    worksheet.write(0, 6, "Condition")
    worksheet.write(0, 7, "Price")
    worksheet.write(0, 8, "Sqft")
    worksheet.write(0, 9, "Psf")
    worksheet.write(0, 10, "PPG Link")
    worksheet.write(0, 11, "PPG Link ID")

    exit_main = False
    counter = 0
    while exit_main == False:
        info_list = task(list_of_URLs[counter])
        counter += 1
        if counter == len(list_of_URLs):
            exit_main = True
        write_in_excel_row(counter)

    browser.quit()
